#projeto/.github/workflows/update-readme.yml

name: Executar update-readme.py

on:
  push:
    branches:
      - main  # Executa automaticamente apenas com push na branch main
  workflow_dispatch:  # Permite execu√ß√£o manual via bot√£o no GitHub Actions

jobs:
  run-script:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Permite escrever no reposit√≥rio (necess√°rio para o push)

    steps:
      # Passo 1: Fazer checkout do c√≥digo
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v3

      # Passo 2: Configurar ambiente Python
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Passo 3: Ajustar fuso hor√°rio para Bras√≠lia
      - name: Ajustar fuso hor√°rio para Bras√≠lia
        run: |
          sudo apt-get update
          sudo apt-get install -y tzdata
          sudo ln -fs /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
          sudo dpkg-reconfigure -f noninteractive tzdata

      # Passo 4: Instalar depend√™ncias necess√°rias para o script
      - name: Instalar pytz
        run: pip install pytz

      # Passo 5: Executar o script Python
      - name: Executar update-readme.py
        run: python .github/workflows/update-readme.py

      # Passo 6: Configurar Git para commit autom√°tico
      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Passo 7: Fazer commit e push apenas se houver mudan√ßas reais
      - name: Commit e push do README.md e versao.txt
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo '‚úÖ Nenhuma mudan√ßa detectada. Nada a fazer.'
          else
            echo 'üöÄ Mudan√ßas detectadas. Comitando arquivos...'
            git add .
            git commit -m 'üìÑ Atualiza√ß√£o autom√°tica do README.md via GitHub Actions'

            echo "üîÑ Tentando rebase antes do push..."
            git pull --rebase origin main || {
              echo '‚ö†Ô∏è Conflito detectado. Abortando rebase e ignorando commit.'
              git rebase --abort || true
              exit 0
            }

            git push
            echo '‚úÖ Push realizado com sucesso.'
          fi
