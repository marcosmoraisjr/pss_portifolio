# .github/workflows/update_readme.yml

name: Executar update_readme.py

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Ajustar fuso hor√°rio para Bras√≠lia
        run: |
          sudo apt-get update
          sudo apt-get install -y tzdata
          sudo ln -fs /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
          sudo dpkg-reconfigure -f noninteractive tzdata

      - name: Instalar depend√™ncias (Pillow e pytz)
        run: python -m pip install Pillow pytz

      - name: Executar update_readme.py
        run: python .github/workflows/update_readme.py

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit e push do README.md e versao.txt
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo '‚úÖ Nenhuma mudan√ßa detectada. Nada a fazer.'
          else
            echo 'üöÄ Mudan√ßas detectadas. Comitando arquivos...'
            git add .
            git commit -m 'üìÑ Atualiza√ß√£o autom√°tica do README.md via GitHub Actions'

            echo "üîÑ Tentando rebase antes do push..."
            git pull --rebase origin main || {
              echo '‚ö†Ô∏è Conflito detectado. Abortando rebase e ignorando commit.'
              git rebase --abort || true
              exit 0
            }

            git push
            echo '‚úÖ Push realizado com sucesso.'
          fi
